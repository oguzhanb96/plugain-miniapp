<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Mini App</title>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // Firebase Konfigürasyonu
    const firebaseConfig = {
      apiKey: "AIzaSyBwwATHKjJbwUQT7sNEHl-fVJUAN0mNqpk",
      authDomain: "plugain.firebaseapp.com",
      databaseURL: "https://plugain-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "plugain",
      storageBucket: "plugain.firebasestorage.app",
      messagingSenderId: "693636169295",
      appId: "1:693636169295:web:fc965cea5bfe7b88bcb43a",
      measurementId: "G-ENH4WNHVE4"
    };

    // Firebase Başlatma
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); // Firebase veritabanı bağlantısı

    // Telegram Web App'den kullanıcı bilgilerini alma
    const tg = window.Telegram.WebApp;
    tg.initDataUnsafe = JSON.parse(tg.initData);
    const user = tg.initDataUnsafe;

    if (user) {
      const username = user.username || "Bilinmeyen Kullanıcı";  // Kullanıcı adı
      const userId = user.id;  // Kullanıcı ID'si

      // Firebase'deki kullanıcı verisini alıyoruz
      const userRef = ref(db, 'kullanicilar/' + username);  // Firebase'deki kullanıcının referansını al
      get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
          const userData = snapshot.val();  // Kullanıcı verilerini al
          const currentTokens = userData.puan || 0;  // Token sayısını al
          document.getElementById("token").textContent = currentTokens;
          document.getElementById("username").textContent = username;
        } else {
          console.log("Kullanıcı verisi bulunamadı.");
        }
      }).catch((error) => {
        console.error("Veri alınırken hata oluştu:", error);
      });
    }

    // Token Topla butonuna tıklama işlemi
    document.getElementById("collect").addEventListener("click", () => {
      if (user) {
        const username = user.username || "Bilinmeyen Kullanıcı";  // Kullanıcı adı
        const userRef = ref(db, 'kullanicilar/' + username);  // Kullanıcı verisini Firebase'den al

        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            let currentTokens = userData.puan || 0;  // Mevcut token sayısını al
            currentTokens += 1;  // Token sayısını arttır

            // Yeni token sayısını Firebase'e kaydediyoruz
            set(userRef, {
              puan: currentTokens  // Puanı güncelliyoruz
            }).then(() => {
              // Sayfada token sayısını güncelliyoruz
              document.getElementById("token").textContent = currentTokens;
              document.getElementById("status").textContent = "Durum: Token toplandı!";
            });
          } else {
            console.log("Kullanıcı verisi bulunamadı.");
          }
        }).catch((error) => {
          console.error("Veri alınırken hata oluştu:", error);
        });
      }
    });
  </script>
</head>
<body>
  <div>
    <h1>Telegram Mini App</h1>
    <p><strong>Kullanıcı:</strong> <span id="username">Yükleniyor...</span></p>
    <p><strong>Token Sayısı:</strong> <span id="token">Yükleniyor...</span></p>
    <button id="collect">Token Topla</button>
    <p id="status">Durum: Bekliyor...</p>
  </div>
</body>
</html>
